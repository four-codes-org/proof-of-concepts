sqs-access-policy

```json
{
  "Version": "2012-10-17",
  "Id": "Policy1651140347168",
  "Statement": [
    {
      "Sid": "Stmt1651140341677",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "sqs:SendMessage",
      "Resource": "*"
    }
  ]
}
```

python script

```py
import requests
import json
import boto3

s3Client = boto3.client('s3')
sqsClient = boto3.client('sqs')

# Read as Environment variable
apiGatewayUrl="https://td6rfssqf2.execute-api.ap-southeast-1.amazonaws.com/dev"
sqsUrl="https://sqs.ap-southeast-1.amazonaws.com/653413855845/dodo"
apiGatewayId="td6rfssqf2"
destinationBucketName="staging-bucket-dodo"

def deleteQueueMessage(sqsUrl, ReceiptHandle):
    return sqsClient.delete_message(QueueUrl=sqsUrl,ReceiptHandle=ReceiptHandle)

def lambda_handler(event, context):
    while True:
        res = requests.get(apiGatewayUrl, headers={"x-apigw-api-id": apiGatewayId})
        if res.status_code == 200:
            stageOne = res.json()
            if stageOne['ReceiveMessageResponse']['ReceiveMessageResult']['messages'] == None:
                print("No messages received.")
                break
            else:
                stageTwo = stageOne['ReceiveMessageResponse']['ReceiveMessageResult']['messages'][0]['Body']
                stageThree = json.loads(stageTwo)
                stageFour = json.loads(stageThree['Message'])
                if 'Records' in stageFour:
                    s3Data=stageFour['Records'][0]['s3']
                    source_bucket_name = s3Data['bucket']['name']
                    file_name = s3Data['object']['key']
                    copy_object = {'Bucket': source_bucket_name, 'Key': file_name}
                    print(copy_object)
                    print("Copy the source object to destination bucket")
                    s3Client.copy_object(CopySource=copy_object, Bucket=destinationBucketName, Key=file_name)
                    print("Delete the source object in source bucket")
                    s3Client.delete_object(Bucket=source_bucket_name, Key=file_name)
                    ReceiptHandle=stageOne['ReceiveMessageResponse']['ReceiveMessageResult']['messages'][0]['ReceiptHandle']
                    print(ReceiptHandle)
                    deleteQueueMessage(sqsUrl,ReceiptHandle)
                else:
                    print("no records received")
        else:
            print("something wrong in apiGateway endpoint.")
            break
```

second senario

```py
import requests
import json
import boto3
import datetime
s3Client = boto3.client('s3')
sqsClient = boto3.client('sqs')

# Read as Environment variable
apiGatewayUrl="https://td6rfssqf2.execute-api.ap-southeast-1.amazonaws.com/dev"
sqsUrl="https://sqs.ap-southeast-1.amazonaws.com/653413855845/dodo"
apiGatewayId="td6rfssqf2"
destinationBucketName="staging-bucket-dodo"

alertSqsQueueURL=""

def pushResultsToQueue(queue_url, file_path, scan_result):
    scanner_status = 'Generated by the scan-to-final-bucket lambda.'
    queue_message = {
        "timestamp": datetime.now().isoformat(timespec='seconds'),
        "scanner_status": scanner_status,
        "file_path": file_path,
        "scan_result": scan_result
    }


    json_messsage = json.dumps(queue_message)
    return sqsClient.send_message(QueueUrl=queue_url, MessageBody=json_messsage)


def deleteQueueMessage(sqsUrl, ReceiptHandle):
    return sqsClient.delete_message(QueueUrl=sqsUrl,ReceiptHandle=ReceiptHandle)

def lambda_handler(event, context):
    while True:
        res = requests.get(apiGatewayUrl, headers={"x-apigw-api-id": apiGatewayId})
        if res.status_code == 200:
            stageOne = res.json()
            if stageOne['ReceiveMessageResponse']['ReceiveMessageResult']['messages'] == None:
                print("No messages received.")
                break
            else:
                stageTwo = stageOne['ReceiveMessageResponse']['ReceiveMessageResult']['messages'][0]['Body']
                stageThree = json.loads(stageTwo)
                stageFour = json.loads(stageThree['Message'])
                if 'Records' in stageFour:
                    s3Data=stageFour['Records'][0]['s3']
                    source_bucket_name = s3Data['bucket']['name']
                    file_name = s3Data['object']['key']
                    copy_object = {'Bucket': source_bucket_name, 'Key': file_name}
                    print(copy_object)
                    print("Copy the source object to destination bucket")
                    s3Client.copy_object(CopySource=copy_object, Bucket=destinationBucketName, Key=file_name)
                    pushResultsToQueue(alertSqsQueueURL,file_name, "Scan Success")
                    print("Delete the source object in source bucket")
                    s3Client.delete_object(Bucket=source_bucket_name, Key=file_name)
                    ReceiptHandle=stageOne['ReceiveMessageResponse']['ReceiveMessageResult']['messages'][0]['ReceiptHandle']
                    print(ReceiptHandle)
                    deleteQueueMessage(sqsUrl,ReceiptHandle)
                else:
                    print("no records received")
        else:
            print("something wrong in apiGateway endpoint.")
            break
```


_event bridge to sqs_

```json
{
  "Version": "2008-10-17",
  "Id": "__default_policy_ID",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "events.amazonaws.com"
      },
      "Action": "SQS:SendMessage",
      "Resource": "*"
    }
  ]
}
```

```py
import requests
import json
import datetime
import urllib
import boto3

s3Client = boto3.client('s3')
sqsClient = boto3.client('sqs')

# Read as Environment variable
apiGatewayUrl = "https://yhszbtwj6e.execute-api.ap-southeast-1.amazonaws.com/demo?Action=ReceiveMessage&MaxNumberOfMessages=10"
sqsUrl = "https://sqs.ap-southeast-1.amazonaws.com/676487226531/a1-s3-sqs.fifo"
apiGatewayId = "yhszbtwj6e"
originBucketName = "dodo-safe-intranet"
success_destination_bucket_name = "dodo-final-intranet"
failed_destination_bucket_name = "dodo-quarantined-intranet"
alertSqsQueueURL="https://sqs.ap-southeast-1.amazonaws.com/876119793288/fhq-prod-antivirus-cloud"

def pushResultsToQueue(queue_url, file_path, scan_result):
    scanner_status = 'Generated by the scan-to-final-bucket lambda.'
    queue_message = {
        "timestamp": datetime.datetime.now().isoformat(timespec='seconds'),
        "scanner_status": scanner_status,
        "file_path": file_path,
        "scan_result": scan_result
    }
    json_messsage = json.dumps(queue_message)
    return sqsClient.send_message(QueueUrl=queue_url, MessageBody=json_messsage)

def checkSumIntegrity(sourceBucket, destinationBucket, filename):
    s3Client = boto3.client('s3')
    source = s3Client.get_object(Bucket=sourceBucket, ChecksumMode='ENABLED', Key=filename)
    destination = s3Client.get_object(Bucket=destinationBucket, ChecksumMode='ENABLED', Key=filename)
    sourceCheckpoint = 'ChecksumSHA256' in source.keys()
    destinationCheckpoint = 'ChecksumSHA256' in destination.keys()
    if (sourceCheckpoint == True and destinationCheckpoint== True):
        if (source['ChecksumSHA256'] == destination['ChecksumSHA256']):
            return True
        else:
            return False
    else:
        return False


def deleteQueueMessage(sqsUrl, ReceiptHandle):
    return sqsClient.delete_message(QueueUrl=sqsUrl,ReceiptHandle=ReceiptHandle)

def getObjectDetails(buckeName, fileName):
    results = s3Client.list_objects(Bucket=buckeName, Prefix=fileName)
    return 'Contents' in results

def lambda_handler(event, context):
    while True:
        res = requests.get(apiGatewayUrl)
        # res = requests.get(apiGatewayUrl, headers={"x-apigw-api-id": apiGatewayId})
        if res.status_code == 200:
            stageOne = res.json()
            if stageOne['ReceiveMessageResponse']['ReceiveMessageResult']['messages'] == None:
                print(json.dumps({ "Message": False, "statusCode": 200  }))
                break
            else:
                iterate = stageOne['ReceiveMessageResponse']['ReceiveMessageResult']['messages']
                for events in iterate:
                    ReceiptHandle= events['ReceiptHandle']
                    s3Data = json.loads(events['Body'])
                    file_name = urllib.parse.unquote_plus(s3Data['detail']['requestParameters']['key'])
                    source_bucket_name = urllib.parse.unquote_plus(s3Data['detail']['requestParameters']['bucketName'])
                    copy_object = {'Bucket': source_bucket_name, 'Key': file_name}

                    fileExistStatus = getObjectDetails(source_bucket_name, file_name)
                    if fileExistStatus == True:
                        tags = s3Client.get_object_tagging(Bucket=source_bucket_name, Key=file_name)
                        data = tags['TagSet']
                        output_dict = [x for x in data if x['Key'] == 'fss-scan-result']
                        
                        if 'no issues found' == output_dict[0]['Value']:
                            s3ObjectChecksum = checkSumIntegrity(originBucketName, source_bucket_name, file_name)
                            if (s3ObjectChecksum ==  True):
                                s3Client.copy_object(CopySource=copy_object, Bucket=success_destination_bucket_name, Key=file_name)
                                s3Client.delete_object(Bucket=source_bucket_name, Key=file_name)
                                # pushResultsToQueue(alertSqsQueueURL, file_name, "success")
                                deleteQueueMessage(sqsUrl, ReceiptHandle)
                            else:
                                s3Client.copy_object(CopySource=copy_object, Bucket=failed_destination_bucket_name, Key=file_name)
                                s3Client.delete_object(Bucket=source_bucket_name, Key=file_name)
                                # pushResultsToQueue(alertSqsQueueURL, file_name, "failure")
                                deleteQueueMessage(sqsUrl, ReceiptHandle)
                        else:
                            s3Client.copy_object(CopySource=copy_object, Bucket=failed_destination_bucket_name, Key=file_name)
                            s3Client.delete_object(Bucket=source_bucket_name, Key=file_name)
                            # pushResultsToQueue(alertSqsQueueURL, file_name, "failure")
                            deleteQueueMessage(sqsUrl, ReceiptHandle)
                    else:
                        deleteQueueMessage(sqsUrl, ReceiptHandle)

        else:
            print(json.dumps({ "Message": "api issues", "statusCode": 500  }))
            break

```
